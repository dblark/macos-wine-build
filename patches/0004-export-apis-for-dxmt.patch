From b65ef2967b8c675280e7950c56bb8006a1e671dd Mon Sep 17 00:00:00 2001
From: dblark <dblark@stu.pku.edu.cn>
Date: Fri, 28 Nov 2025 18:49:19 +0800
Subject: [PATCH 4/4] export apis for dxmt

---
 dlls/winemac.drv/Makefile.in |   3 +-
 dlls/winemac.drv/d3dmetal.c  | 159 +++++++++++++++++++++++++++++++++++
 2 files changed, 161 insertions(+), 1 deletion(-)
 create mode 100644 dlls/winemac.drv/d3dmetal.c

diff --git a/dlls/winemac.drv/Makefile.in b/dlls/winemac.drv/Makefile.in
index 621388f2bd8..4b4dd0224e1 100644
--- a/dlls/winemac.drv/Makefile.in
+++ b/dlls/winemac.drv/Makefile.in
@@ -1,7 +1,7 @@
 MODULE    = winemac.drv
 UNIXLIB   = winemac.so
 IMPORTS   = uuid rpcrt4 user32 gdi32 win32u
-DELAYIMPORTS = ole32 shell32 imm32
+DELAYIMPORTS = advapi32 ole32 shell32 imm32
 UNIX_LIBS    = \
 	-lwin32u \
 	-framework AppKit \
@@ -25,6 +25,7 @@ SOURCES = \
 	cocoa_opengl.m \
 	cocoa_status_item.m \
 	cocoa_window.m \
+	d3dmetal.c \
 	display.c \
 	dllmain.c \
 	event.c \
diff --git a/dlls/winemac.drv/d3dmetal.c b/dlls/winemac.drv/d3dmetal.c
new file mode 100644
index 00000000000..824e0d13449
--- /dev/null
+++ b/dlls/winemac.drv/d3dmetal.c
@@ -0,0 +1,159 @@
+/*
+ * Mac graphics driver hooks used by D3DMetal (part of the Apple Game Porting Toolkit)
+ *
+ * Copyright 2023 Brendan Shanks for CodeWeavers, Inc.
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#if 0
+#pragma makedep unix
+#endif
+
+#if defined(__x86_64__)
+
+#include "config.h"
+
+#include "ntstatus.h"
+#define WIN32_NO_STATUS
+#include "macdrv.h"
+#include "shellapi.h"
+#include "wine/server.h"
+
+WINE_DEFAULT_DEBUG_CHANNEL(macdrv_d3dmtl);
+
+typedef LONG LSTATUS;
+
+struct macdrv_functions_t
+{
+    void (*macdrv_init_display_devices)(BOOL);
+    struct d3dmetal_macdrv_win_data* (*get_win_data)(HWND hwnd);
+    void (*release_win_data)(struct d3dmetal_macdrv_win_data *data);
+    macdrv_window(*macdrv_get_cocoa_window)(HWND hwnd, BOOL require_on_screen);
+    macdrv_metal_device (*macdrv_create_metal_device)(void);
+    void (*macdrv_release_metal_device)(macdrv_metal_device d);
+    macdrv_metal_view (*macdrv_view_create_metal_view)(macdrv_view v, macdrv_metal_device d);
+    macdrv_metal_layer (*macdrv_view_get_metal_layer)(macdrv_metal_view v);
+    void (*macdrv_view_release_metal_view)(macdrv_metal_view v);
+    void (*on_main_thread)(dispatch_block_t b);
+};
+
+/* macdrv private window data expected by D3DMetal */
+struct d3dmetal_macdrv_win_data
+{
+    HWND                hwnd;                   /* hwnd that this private data belongs to */
+    macdrv_window       cocoa_window;
+    macdrv_view         cocoa_view;
+    macdrv_view         client_cocoa_view;
+    void *              padding[2];             /* used to be struct window_surface* surface/unminimized_surface */
+};
+
+void OnMainThread(dispatch_block_t block);
+
+static void my_macdrv_init_display_devices(BOOL p1)
+{
+    TRACE("macdrv_init_display_devices %d - no-op\n", p1);
+}
+
+static struct d3dmetal_macdrv_win_data *my_get_win_data(HWND hwnd)
+{
+    struct macdrv_win_data *data;
+    struct d3dmetal_macdrv_win_data *d3dm_data;
+    TRACE("get_win_data %p\n", hwnd);
+
+    data = get_win_data(hwnd);
+    if (!data)
+        return NULL;
+
+    d3dm_data = calloc(1, sizeof(*d3dm_data));
+
+    d3dm_data->hwnd = data->hwnd;
+    d3dm_data->cocoa_window = data->cocoa_window;
+    d3dm_data->cocoa_view = data->cocoa_view;
+    d3dm_data->client_cocoa_view = data->client_cocoa_view;
+
+    d3dm_data->padding[0] = data;
+
+    return d3dm_data;
+}
+
+static void my_release_win_data(struct d3dmetal_macdrv_win_data *data)
+{
+    TRACE("release_win_data %p\n", data);
+
+    if (!data)
+        return;
+
+    release_win_data(data->padding[0]);
+    free(data);
+}
+
+static macdrv_window my_macdrv_get_cocoa_window(HWND hwnd, BOOL require_on_screen)
+{
+    TRACE("macdrv_get_cocoa_window %p %d\n", hwnd, require_on_screen);
+    return macdrv_get_cocoa_window(hwnd, require_on_screen);
+}
+
+static macdrv_metal_device my_macdrv_create_metal_device(void)
+{
+    TRACE("macdrv_create_metal_device\n");
+    return macdrv_create_metal_device();
+}
+
+static void my_macdrv_release_metal_device(macdrv_metal_device d)
+{
+    TRACE("macdrv_release_metal_device %p\n", d);
+    macdrv_release_metal_device(d);
+}
+
+static macdrv_metal_view my_macdrv_view_create_metal_view(macdrv_view v, macdrv_metal_device d)
+{
+    TRACE("macdrv_view_create_metal_view %p %p\n", v, d);
+    return macdrv_view_create_metal_view(v, d);
+}
+
+static macdrv_metal_layer my_macdrv_view_get_metal_layer(macdrv_metal_view v)
+{
+    TRACE("macdrv_view_get_metal_layer %p\n", v);
+    return macdrv_view_get_metal_layer(v);
+}
+
+static void my_macdrv_view_release_metal_view(macdrv_metal_view v)
+{
+    TRACE("macdrv_view_release_metal_view %p\n", v);
+    return macdrv_view_release_metal_view(v);
+}
+
+static void my_OnMainThread(dispatch_block_t b)
+{
+    TRACE("OnMainThread %p\n", b);
+    OnMainThread(b);
+}
+
+DECLSPEC_EXPORT struct macdrv_functions_t macdrv_functions =
+{
+    &my_macdrv_init_display_devices,
+    &my_get_win_data,
+    &my_release_win_data,
+    &my_macdrv_get_cocoa_window,
+    &my_macdrv_create_metal_device,
+    &my_macdrv_release_metal_device,
+    &my_macdrv_view_create_metal_view,
+    &my_macdrv_view_get_metal_layer,
+    &my_macdrv_view_release_metal_view,
+    &my_OnMainThread,
+};
+
+#endif
-- 
2.52.0

